#!/usr/bin/env ruby
# frozen_string_literal: true

# Script to set up Git hooks
# Run this after cloning the repository or when hooks are updated

require "fileutils"
require "digest"

# Hook version - update this when the hook logic changes
HOOK_VERSION = "1.0.0"

git_dir = `git rev-parse --git-common-dir`.strip
hooks_dir = File.join(git_dir, "hooks")
pre_commit_hook = File.join(hooks_dir, "pre-commit")
project_root = File.expand_path("..", __dir__)

puts "Setting up Git hooks..."

# Create hooks directory if it doesn't exist
FileUtils.mkdir_p(hooks_dir) unless File.directory?(hooks_dir)

# Create the pre-commit hook
hook_content = <<~BASH
  #!/bin/bash
  # Pre-commit hook to run linting and tests on staged files
  # Version: #{HOOK_VERSION}

  set -e

  # Colors for output
  RED='\\033[0;31m'
  GREEN='\\033[0;32m'
  YELLOW='\\033[1;33m'
  NC='\\033[0m' # No Color

  echo -e "${YELLOW}Running pre-commit checks...${NC}"

  # Get the list of staged Ruby files
  STAGED_RUBY_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\\.rb$' || true)

  if [ -n "$STAGED_RUBY_FILES" ]; then
    echo -e "${YELLOW}Checking Ruby files with RuboCop...${NC}"

    # Run RuboCop on staged files only
    if ! bundle exec rubocop $STAGED_RUBY_FILES; then
      echo -e "${RED}RuboCop failed! Please fix the issues before committing.${NC}"
      echo -e "${YELLOW}You can run 'bundle exec rubocop -a' to auto-fix some issues.${NC}"
      exit 1
    fi

    echo -e "${GREEN}RuboCop passed!${NC}"

    # Find corresponding spec files for changed lib files
    SPEC_FILES=""
    for file in $STAGED_RUBY_FILES; do
      if [[ $file == lib/* ]]; then
        # Convert lib/package_json/foo.rb to spec/package_json/foo_spec.rb
        spec_file=$(echo "$file" | sed 's|^lib/|spec/|' | sed 's|\\.rb$|_spec.rb|')
        if [ -f "$spec_file" ]; then
          SPEC_FILES="$SPEC_FILES $spec_file"
        fi
      elif [[ $file == spec/* ]]; then
        # If it's already a spec file, include it
        SPEC_FILES="$SPEC_FILES $file"
      fi
    done

    if [ -n "$SPEC_FILES" ]; then
      echo -e "${YELLOW}Running affected RSpec tests...${NC}"
      if ! bundle exec rspec $SPEC_FILES; then
        echo -e "${RED}Tests failed! Please fix the tests before committing.${NC}"
        exit 1
      fi
      echo -e "${GREEN}Affected tests passed!${NC}"
    else
      echo -e "${YELLOW}No corresponding spec files found for changed files.${NC}"
    fi
  else
    echo -e "${YELLOW}No Ruby files to check.${NC}"
  fi

  echo -e "${GREEN}All pre-commit checks passed!${NC}"
  exit 0
BASH

File.write(pre_commit_hook, hook_content)
FileUtils.chmod(0o755, pre_commit_hook)

puts "✓ Pre-commit hook installed at #{pre_commit_hook}"
puts "  Version: #{HOOK_VERSION}"
puts ""
puts "The pre-commit hook will:"
puts "  • Run RuboCop on staged Ruby files only (fast)"
puts "  • Run RSpec tests for affected files only (fast)"
puts "  • Full test suite runs in CI"
puts ""
puts "To bypass the hook (not recommended), use: git commit --no-verify"
puts ""
puts "Note: Run 'bundle exec rubocop' before pushing to ensure all files pass linting."
