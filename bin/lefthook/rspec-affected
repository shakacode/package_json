#!/usr/bin/env bash
# Run RSpec tests for affected files
set -euo pipefail

if [ $# -eq 0 ]; then
  echo "âœ… No Ruby files changed"
  exit 0
fi

# Find corresponding spec files for changed lib files
spec_files=()
for file in "$@"; do
  if [[ $file == lib/* ]]; then
    # Convert lib/package_json/foo.rb to spec/package_json/foo_spec.rb
    spec_file=$(echo "$file" | sed 's|^lib/|spec/|' | sed 's|\.rb$|_spec.rb|')
    if [ -f "$spec_file" ]; then
      spec_files+=("$spec_file")
    fi
  elif [[ $file == spec/* ]]; then
    # If it's already a spec file, include it
    spec_files+=("$file")
  fi
done

if [ ${#spec_files[@]} -eq 0 ]; then
  echo "âœ… No corresponding spec files found for changed files"
  exit 0
fi

echo "ğŸ§ª Running affected RSpec tests:"
printf "  %s\n" "${spec_files[@]}"

if ! bundle exec rspec "${spec_files[@]}"; then
  echo ""
  echo "âŒ Tests failed!"
  echo "ğŸ’¡ Run full suite: bundle exec rspec"
  echo "ğŸš« Skip hook: git commit --no-verify"
  exit 1
fi

echo "âœ… Affected tests passed"
